<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title></title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/app.css">
	<script src="js/jquery-3.7.1.min.js"></script>
	<script src="js/bootstrap.bundle.min.js"></script>
	<script src="js/toast.js"></script>
</head>
<body>
	<header class="app-header">
		<div class="app-name" id="app-name">&nbsp;</div>
		<nav class="nav-bar">
			<a href="index.html">Video</a>
			<a href="image.html">Image</a>
			<a href="config.html" class="active">Config</a>
			<a href="events.html">Events</a>
			<a href="about.html">About</a>
		</nav>
	</header>

	<div class="page-content">
		<div class="col-12 col-md-6 col-lg-3">
			<div class="card">
				<div class="card-header">
					<h5 class="card-title mb-0">Settings</h5>
				</div>
				<div class="card-body" id="settings-form">
				</div>
				<div class="card-footer">
					<button id="save-settings" class="btn btn-primary btn-block">Save Settings</button>
				</div>
			</div>
		</div>
	</div>

<script>
$(document).ready(function() {
	$.ajax({
		type: "GET",
		url: 'app',
		dataType: 'json',
		cache: false,
		success: function(data) {
			document.title = data.manifest.acapPackageConf.setup.friendlyName;
			$('#app-name').text(data.manifest.acapPackageConf.setup.friendlyName);
			buildSettingsForm(data.settings);
		},
		error: function(response) {
			showToast("Failed to load device information: " + response.statusText, 'danger');
		}
	});

	$('#save-settings').on('click', function() {
		const newSettings = collectSettings();
		$.ajax({
			type: "POST",
			url: "settings",
			contentType: 'application/json',
			data: JSON.stringify(newSettings),
			success: function(response) {
				currentSettings = newSettings;
				showToast("Settings saved", 'success');
			},
			error: function(xhr, status, error) {
				showToast("Failed to save settings: " + error, 'danger');
			}
		});
	});

	function generateInputForSetting(key, value) {
		let inputType = 'text';
		let inputClass = 'form-control';
		switch (typeof value) {
			case 'number':
				inputType = 'number';
				break;
			case 'boolean':
				return `
					<div class="form-group row align-items-center mb-2">
						<label class="col-6 col-form-label">${key.charAt(0).toUpperCase() + key.slice(1)}</label>
						<div class="col-6">
							<div class="custom-control custom-checkbox">
								<input type="checkbox" class="custom-control-input setting-input"
									   id="${key}" name="${key}"
									   ${value ? 'checked' : ''}>
								<label class="custom-control-label" for="${key}"></label>
							</div>
						</div>
					</div>
				`;
			case 'string':
			default:
				inputType = 'text';
		}
		return `
			<div class="form-group row align-items-center mb-2">
				<label for="${key}" class="col-6 col-form-label">${key.charAt(0).toUpperCase() + key.slice(1)}</label>
				<div class="col-6">
					<input type="${inputType}"
						   class="${inputClass} setting-input"
						   id="${key}"
						   name="${key}"
						   value="${value}">
				</div>
			</div>
		`;
	}

	function buildSettingsForm(settings) {
		const settingsForm = $('#settings-form');
		settingsForm.empty();
		Object.entries(settings).forEach(([key, value]) => {
			settingsForm.append(generateInputForSetting(key, value));
		});
	}

	function collectSettings() {
		const settings = {};
		$('.setting-input').each(function() {
			const $input = $(this);
			const key = $input.attr('name');
			let value;
			if ($input.attr('type') === 'checkbox') {
				value = $input.is(':checked');
			} else if ($input.attr('type') === 'number') {
				value = parseFloat($input.val());
			} else {
				value = $input.val();
			}
			settings[key] = value;
		});
		return settings;
	}
});
</script>
</body>
</html>
